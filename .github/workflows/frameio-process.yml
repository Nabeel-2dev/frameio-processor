name: Frame.io Folder Processor

on:
  repository_dispatch:
    types: [process-folder]

env:
  AIRTABLE_TOKEN: "patB9bR2XxXnsI2Q1.cfe4d92a530b46db8be06a5c3f70d699666eabaec7198ef54ea98e4d9d049523"
  AIRTABLE_BASE_ID: "app6tQcsOfgwuSEUs"
  TABLE_NAME: "tblRM41W5vwvd79gw"

jobs:
  process-folder:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Extract Parameters
      id: params
      run: |
        echo "folder_url=${{ github.event.client_payload.folderUrl }}" >> $GITHUB_OUTPUT
        echo "record_id=${{ github.event.client_payload.recordId }}" >> $GITHUB_OUTPUT
        echo "script_url=${{ github.event.client_payload.scriptUrl }}" >> $GITHUB_OUTPUT
        
        echo "📝 Parameters:"
        echo "  Folder: ${{ github.event.client_payload.folderUrl }}"
        echo "  Record: ${{ github.event.client_payload.recordId }}"
        echo "  Script: ${{ github.event.client_payload.scriptUrl }}"

    - name: Process Frame.io Upload
      run: |
        echo "🚀 Starting Frame.io processing..."
        echo "Folder URL: ${{ steps.params.outputs.folder_url }}"
        echo "Record ID: ${{ steps.params.outputs.record_id }}"
        echo "Script URL: ${{ steps.params.outputs.script_url }}"
        
        # Function to call Google Apps Script with retry logic
        call_script() {
          local action=$1
          local params=$2
          local max_attempts=3
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "📞 Calling: $action (attempt $attempt/$max_attempts)"
            
            local response=$(curl -s -L \
              --max-time 300 \
              --retry 2 \
              --retry-delay 5 \
              "$script_url?action=$action$params")
            
            if [ $? -eq 0 ] && [ -n "$response" ]; then
              echo "$response"
              return 0
            fi
            
            echo "🔄 Retrying in 5 seconds..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo "❌ Failed after $max_attempts attempts"
          return 1
        }
        
        script_url="${{ steps.params.outputs.script_url }}"
        record_id="${{ steps.params.outputs.record_id }}"
        
        # Step 1: Initialize folder
        echo "📁 Step 1: Initializing folder..."
        init_response=$(call_script "initFolder" "&folderUrl=${{ steps.params.outputs.folder_url }}")
        
        if echo "$init_response" | grep -q '"ok":false'; then
          echo "❌ Init error: $(echo "$init_response" | grep -o '"error":"[^"]*"' | sed 's/"error":"//;s/"//')"
          exit 1
        fi
        
        echo "✅ Files found for processing"
        echo "$init_response"
        
        # Extract group ID
        group_id=$(echo "$init_response" | grep -o '"groupId":"[^"]*"' | sed 's/"groupId":"//;s/"//')
        
        if [ -z "$group_id" ] || [ "$group_id" = "null" ]; then
          echo "ℹ️  No files found for processing"
          exit 0
        fi
        
        echo "🆔 Group ID: $group_id"
        
        # Extract asset IDs from init response
        asset_ids=$(echo "$init_response" | grep -o '"assetId":"[^"]*"' | sed 's/"assetId":"//;s/"//')
        
        if [ -z "$asset_ids" ]; then
          echo "❌ No asset IDs found in init response"
          exit 1
        fi
        
        echo "📊 Found assets:"
        echo "$asset_ids" | while read asset_id; do
          echo "  🎬 Asset ID: $asset_id"
        done
        
        # Step 2: Upload each asset individually
        echo "📤 Step 2: Starting uploads..."
        while read -r asset_id; do
          if [ -n "$asset_id" ]; then
            echo "⬆️  Uploading asset: $asset_id"
            
            while true; do
              upload_response=$(call_script "uploadAsset" "&assetId=$asset_id&budget_ms=240000&window=4&pace_ms=500")
              
              echo "Upload response: $upload_response"
              
              # Check if upload is complete
              if echo "$upload_response" | grep -q '"paused":false'; then
                echo "✅ Asset $asset_id upload completed!"
                break
              elif echo "$upload_response" | grep -q '"ok":false'; then
                echo "❌ Upload error for $asset_id: $(echo "$upload_response" | grep -o '"error":"[^"]*"' | sed 's/"error":"//;s/"//')"
                exit 1
              else
                echo "⏳ Upload continuing for $asset_id..."
                sleep 5
              fi
            done
          fi
        done <<< "$asset_ids"
        
        echo "✅ All assets uploaded successfully!"
        
        # Step 3: Finalize and get review link
        echo "🔗 Step 3: Creating Frame.io review link..."
        finalize_response=$(call_script "finalizeFolder" "&groupId=$group_id")
        
        if echo "$finalize_response" | grep -q '"ok":false'; then
          echo "❌ Finalize error: $(echo "$finalize_response" | grep -o '"error":"[^"]*"' | sed 's/"error":"//;s/"//')"
          exit 1
        fi
        
        echo "✅ Finalization successful!"
        echo "$finalize_response"
        
        # Extract review link
        review_link=$(echo "$finalize_response" | grep -o '"reviewLink":"[^"]*"' | sed 's/"reviewLink":"//;s/"//')
        
        if [ -z "$review_link" ]; then
          echo "❌ No review link found in response"
          exit 1
        fi
        
        echo "🎬 Frame.io Review Link: $review_link"
        echo "REVIEW_LINK=$review_link" >> $GITHUB_ENV

    - name: Update Airtable Record
      run: |
        echo "📝 Updating Airtable record..."
        echo "🔧 Debug info:"
        echo "  Base ID: $AIRTABLE_BASE_ID"
        echo "  Table ID: $TABLE_NAME"
        echo "  Record ID: ${{ steps.params.outputs.record_id }}"
        echo "  Review Link: $REVIEW_LINK"
        
        echo "✅ Updating with Frame.io link: $REVIEW_LINK"
        
        # Store the curl response
        response=$(curl -s -w "\n%{http_code}" -X PATCH \
          "https://api.airtable.com/v0/$AIRTABLE_BASE_ID/$TABLE_NAME" \
          -H "Authorization: Bearer $AIRTABLE_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{
            \"records\": [
              {
                \"id\": \"${{ steps.params.outputs.record_id }}\",
                \"fields\": {
                  \"Low Quality Bit.ly Folder Link\": \"$REVIEW_LINK\"
                }
              }
            ]
          }")
        
        # Extract HTTP status code and response body
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo ""
        echo "📊 Airtable API Response:"
        echo "  HTTP Status: $http_code"
        echo "  Response: $response_body"
        
        # Check if the request was successful
        if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
          echo "✅ Airtable record updated successfully with Frame.io link"
        else
          echo "❌ Airtable update failed with HTTP status: $http_code"
          echo "❌ Response body: $response_body"
          exit 1
        fi

    - name: Success Summary
      run: |
        echo ""
        echo "🎉 ========== PROCESSING COMPLETE! =========="
        echo "📁 Folder: ${{ steps.params.outputs.folder_url }}"
        echo "🆔 Record: ${{ steps.params.outputs.record_id }}"
        echo "🎬 Frame.io link: $REVIEW_LINK"
        echo "⏱️  Processing method: STABLE (5-min approach)"
        echo "🚀 Status: SUCCESS"
        echo "=============================================="
